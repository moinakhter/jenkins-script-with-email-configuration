# AI Assistant CI/CD Pipeline with Jenkins

## Overview

This Jenkins pipeline automates the build, testing, and binary generation for an AI assistant system. The system includes services for natural language processing (NLP), BERT and RoBERTa models, face recognition, question answering, translation, hologram face rendering, and wake word detection (ASR). The pipeline checks out the codebase, sets up a Python virtual environment, runs unit tests for all services, generates binary files in parallel, and sends email notifications with build results.

## Prerequisites

- **Jenkins**: Configured with pipeline support and necessary plugins (Git, Email Extension).
- **Python 3.9**: Installed on the Jenkins agent.
- **Pipenv**: For managing Python dependencies.
- **Bitbucket**: Repository access with credentials configured in Jenkins (`bitbucket-cre`).
- **System Requirements**:
  - `sudo` access for file and directory permissions.
  - Shell scripts in `shells/binary_builds/` for generating binaries.
  - Write permissions for `/tmp/assistant`, `/var/lib/jenkins/workspace/assistant3`, and `release` directories.

## Pipeline Structure

The pipeline is defined in a `Jenkinsfile` and consists of the following stages:

### 1. Assistant Checkout
- **Purpose**: Clones the repository and sets up the workspace.
- **Steps**:
  - Grants permissions (`chmod 777`) to `/tmp/assistant` and its contents to avoid permission issues.
  - Clones the `development` branch from the Bitbucket repository (`https://moindizayn@bitbucket.org/dizaynviptech/assistant.git`) using credentials (`bitbucket-cre`).
  - Creates `release` and `.venv` directories.
  - Copies resources from `~/assistant/resources/` to the Jenkins workspace.
  - Sets permissions (`chmod 777`) for the workspace and `assistant/recommendation` directory.

### 2. Environment Initialization
- **Purpose**: Sets up the Python virtual environment and installs dependencies.
- **Steps**:
  - Lists directory contents for debugging (`ls -a`).
  - Verifies Python 3.9 installation (`which python3.9`).
  - Installs `pipenv` using Python 3.9.
  - Installs project dependencies (including dev dependencies) using `pipenv install --dev`.

### 3. Testing Stages
- **Purpose**: Runs unit tests for each service to ensure functionality.
- **Services Tested**:
  - **NLP Service**: Executes `unittest/nlp_service.py`.
  - **BERT Service**: Executes `unittest/bert_service.py`.
  - **RoBERTa Service**: Executes `unittest/roberta_service.py`.
  - **Face Recognition Service**: Executes `unittest/facial_recognition_service.py`.
  - **Question & Answer Service**: Executes `unittest/qa_service.py`.
  - **Translation Service**: Executes `unittest/translation_service.py`.
  - **Hologram Service**: Executes `unittest/hologram_face_service.py`.
  - **Wake Word Service (ASR)**: Executes `unittest/asr_service.py`.
- **Notes**:
  - Tests for NLP, BERT, RoBERTa, Hologram, and Wake Word services use `sudo` due to potential permission requirements.
  - Tests are run using the Python 3.9 virtual environment (`.venv/bin/python3.9`).

### 4. Generating Binary Files
- **Purpose**: Generates binary files for each service in parallel to optimize build time.
- **Parallel Stages**:
  - **Assistant Binary**: Runs `shells/binary_builds/assistant.sh`.
  - **Face Recognition Binary**: Runs `shells/binary_builds/face.sh`.
  - **BERT Binary**: Runs `shells/binary_builds/bert.sh`.
  - **RoBERTa Binary**: Runs `shells/binary_builds/roberta.sh`.
  - **NLP Binary**: Runs `shells/binary_builds/nlp.sh`.
  - **Question and Answer Binary**: Runs `shells/binary_builds/qa.sh`.
  - **Noise Binary**: Runs `shells/binary_builds/noise.sh`.
  - **Translation Binary**: Runs `shells/binary_builds/translation.sh`.
  - **ASR Binary**: Runs `shells/binary_builds/asr.sh`.
  - **Hologram Binary**: Runs `shells/binary_builds/hologram.sh` after a 5-second delay.
- **Notes**:
  - Each binary is generated by a dedicated shell script in `shells/binary_builds/`.
  - Parallel execution reduces total build time.
  - The `release` directory stores the generated binaries.

### 5. Giving Permission
- **Purpose**: Ensures the `release` directory has appropriate permissions.
- **Steps**:
  - Sets `chmod 777` on the `release` directory and its contents.

### 6. Post-Build Actions
- **Purpose**: Sends email notifications with build results.
- **Steps**:
  - Uses the `emailext` plugin to send an email to `me@moinakhter.com`.
  - Subject: Includes build status and job name (`jenkins build:${currentBuild.currentResult}: ${env.JOB_NAME}`).
  - Body: Provides build status and a link to the Jenkins build URL (`${env.BUILD_URL}`).
  - Attaches the build log for debugging.
- **Notes**:
  - Notifications are sent regardless of build outcome (`always` condition).

## Setup Instructions

1. **Configure Jenkins**:
   - Install Jenkins and required plugins (Git, Email Extension).
   - Add Bitbucket credentials (`bitbucket-cre`) in Jenkins credentials manager.
   - Ensure Python 3.9 is installed on the Jenkins agent.

2. **Clone Repository**:
   - The pipeline automatically clones the repository from `product repository` (branch: `development`).

3. **Set Up Resources**:
   - Ensure `~/assistant/resources/` contains necessary resources.
   - Verify write permissions for `/tmp/assistant`, `/var/lib/jenkins/workspace/assistant3`, and `release` directories.

4. **Run the Pipeline**:
   - Create a new Jenkins pipeline job.
   - Point it to the `Jenkinsfile` in the repository.
   - Trigger the pipeline manually or configure automatic triggers (e.g., on code push).

## Testing

The pipeline includes comprehensive unit tests for all services:
- Tests are located in `unittest/`.
- Each test script validates the functionality of its respective service (e.g., intent recognition for NLP, face detection for face recognition).
- Tests are executed using the Python 3.9 virtual environment.
- Ensure test scripts are updated to reflect changes in service implementations.

## Troubleshooting

- **Permission Issues**:
  - Verify `sudo` access for the Jenkins user.
  - Check permissions for `/tmp/assistant`, workspace, and `release` directories.
  - Run the pipeline manually the first time to debug permission issues.
- **Missing Dependencies**:
  - Ensure `pipenv` installs all dependencies correctly.
  - Check `requirements.txt` or `Pipfile` for missing packages.
- **Binary Generation Failures**:
  - Verify shell scripts in `shells/binary_builds/` are executable and correctly configured.
  - Check for errors in the Jenkins console output.
- **Test Failures**:
  - Review test logs for specific errors.
  - Ensure services are running and accessible during testing.

## Notes

- The pipeline assumes a Linux-based Jenkins agent due to `sudo` and shell script usage.
- The `hologram.sh` script includes a 5-second delay to avoid race conditions during parallel execution.
- Regularly update `Pipfile` or `requirements.txt` to reflect dependency changes.
- Monitor email notifications for build failures and review attached logs.

